# 接口

在没有其他特殊说明的情况下，本文档的通用约定如下：

+ 所有接口都具有下面的通用返回形式

```json
{
  "r": 0,
  "r2": 0,
  "err_msg": "",
  "data": ...
}
```

| 名称 | 备注 |
| - | - |
| `r`       | 错误代码 |
| `r2`      | 附加错误代码 |
| `err_msg` | 数据库或逻辑错误信息 |
| `data`    | 特定于接口的返回数据 |

+ 所有字段都必须存在
+ 返回列表的接口中，`count`为返回的记录数，默认`50`，最大`50`，`page`为页码，从`0`开始，默认`0`
+ 时间类字段为以毫秒计的Unix时间戳

---

# Project

## POST `/api/proj_insert`

新增项目。

### 参数（JSON）

| 名称 | 可选 | 备注 |
| - | :-: | - |
| `project_name` | 是 | 新名称，不传则为`"Untitled Project"` |


## POST `/api/proj_delete`

删除项目。

### 参数（JSON）

| 名称 | 备注 |
| - | - |
| `project_id` | 项目ID |


## POST `/api/proj_update`

更新项目名称。

### 参数（JSON）

| 名称 | 备注 |
| - | - |
| `project_id`   | 项目ID |
| `project_name` | 新名称 |


## GET `/api/proj_list`

获取项目列表。

### 参数（Query）

| 名称 | 可选 | 备注 |
| - | :-: | - |
| `count` | 是 ||
| `page`  | 是 ||

### 返回

`data` 为数组，每项定义如下：

```json
{
  "project_id": 0,
  "project_name": "",
  "create_time": 123456
}
```

| 名称 | 备注 |
| - | - |
| `project_id`   | 项目ID |
| `project_name` | 项目名称 |
| `create_at`  | 创建时间 |

---

# Task

## POST `/api/task_insert`

创建任务。

### 参数（JSON）

| 名称 | 可选 | 备注 |
| - | :-: | - |
| `project_id`  | | 所属项目ID |
| `task_name`   | 是 | 任务名称 |
| `status`      | 是 | 状态，整数 |
| `priority`    | 是 | 优先级，整数 |
| `description` | 是 | 描述 |

不执行缺省字段的更新。


## POST `/api/task_update`

更新任务。

### 参数（JSON）

| 名称 | 可选 | 备注 |
| - | :-: | - |
| `task_id`     | | 任务ID |
| `task_name`   | 是 | 任务名称 |
| `status`      | 是 | 状态，整数 |
| `priority`    | 是 | 优先级，整数 |
| `description` | 是 | 描述 |

不执行缺省字段的更新。


## POST `/api/task_delete`

删除任务。

### 参数（JSON）

| 名称 | 备注 |
| - | - |
| `task_id` | 任务ID |


## GET `/api/task_list`

获取任务列表。

### 参数（Query）

| 名称 | 可选 | 备注 |
| - | :-: | - |
| `project_id` | | 所属项目ID |
| `count`  | 是 | |
| `page`   | 是 | |

### 返回

`data`为数组，每项定义如下：

```json
{
  "task_id": 0,
  "task_name": "",
  "status": 0,
  "priority": 0,
  "description": "",
  "create_at": 123456,
  "update_at": 123456
}
```

| 名称 | 备注 |
| - | - |
| `task_id`     | 任务ID |
| `task_name`   | 任务名称 |
| `status`      | 任务状态 |
| `priority`    | 任务优先级 |
| `description` | 任务描述 |
| `create_at`   | 创建时间 |
| `update_at`   | 更新时间 |

---

# TaskLog

## GET `/api/task_log`

获取指定任务的更改记录。

### 参数（Query）

| 名称 | 可选 | 备注 |
| - | :-: | - |
| `task_id` | | 任务ID |
| `count`  | 是 | |
| `page`   | 是 | |

### 返回

`data`为数组，每项定义如下：

```json
{
  "field_name": "",
  "old_value": "",
  "new_value": "",
  "change_at": 123456,
}
```

| 名称 | 备注 |
| - | - |
| `field_name`  | 被修改的Task中的字段名称 |
| `old_value`   | 旧值，字符串 |
| `new_value`   | 新值，字符串 |
| `change_at`   | 修改时间 |

---

# TaskRelation

## POST `/api/task_relation_insert`

增加任务关联项。

### 参数（Query）

| 名称 | 备注 |
| - | - |
| `task_id` | 任务ID |
| `relation_id` | 关联目标项ID |
| `relation_type` | 关联目标项的类型 |

项类型定义如下：

| 名称 | 备注 |
| - | - |
| `0` | 任务 |
| `1` | 文章页面 |
| `2` | 文件 |


## POST `/api/task_relation_delete`

删除任务关联项。

### 参数（Query）

| 名称 | 备注 |
| - | - |
| `taskId` | 任务ID |
| `relationId` | 关联目标项ID |


## GET `/api/task_relation`

获取任务的关联项

### 参数（Query）

| 名称 | 备注 |
| - | - |
| `task_id` | 任务ID |

### 返回

`data`为数组，每项定义如下：

```json
{
  "relation_id": 1,
  "relation_type": 2,
}
```

| 名称 | 备注 |
| - | - |
| `relation_id` | 关联目标项 |
| `relation_type` | 目标项的类型  |

---

# PageGroup

## POST `/api/page_group_insert`

创建新的页面组。

### 参数（JSON）

| 名称 | 可选 | 备注 |
| - | :-: | - |
| `group_name` | 是 | 组名，缺省或空值时默认为 `"Untitled Page Group"` |


## POST `/api/page_group_delete`

删除页面组。

### 参数（JSON）

| 名称 | 备注 |
| - | - |
| `page_group_id` | 分组ID |


## POST `/api/page_group_update`

更新页面分组名称。

### 参数（JSON）

| 名称 | 备注 |
| - | - |
| `page_group_id` | 要修改的分组 ID |
| `group_name`    | 新组名，必须为字符串 |


## GET `/api/page_group_list`

获取分组列表。

### 参数（Query）

| 名称 | 可选 | 备注 |
| - | :-: | - |
| `count` | 是 ||
| `page`  | 是 ||

### 返回

`data` 为数组，每项结构如下：

```json
{
  "page_group_id": 1,
  "group_name": "",
  "create_at": 123456
}
```

字段说明：

| 名称 | 备注 |
| - | - |
| `page_group_id` | 组 ID |
| `group_name`    | 组名 |
| `create_at`     | 创建时间 |

---

# Page

## POST `/api/page_insert`

创建页面。

### 参数（JSON）

| 名称 | 可选 | 备注 |
| - | :-: | - |
| `page_group_id` | | 所属页面组 ID |
| `page_name`     | 是 | 页面名称，默认为`"Untitled Page"` |


## POST `/api/page_update`

更新页面名称。

### 参数（JSON）

| 名称 | 备注 |
| - | - |
| `page_id`   | 页面ID |
| `page_name` | 新名称，字符串 |


## POST `/api/page_delete`

删除页面。

### 参数（JSON）

| 名称 | 备注 |
| - | - |
| `page_id` | 页面 ID |


## GET `/api/page_list`

获取页面列表。

### 参数（Query）

| 名称 | 可选 | 备注 |
| - | :-: | - |
| `group_id` | | 所属页面组 ID（必须存在） |
| `count`    | 是 | 返回条数 |
| `page`     | 是 | 页码 |

### 返回

`data` 为数组，每项定义如下：

```json
{
  "page_id": 0,
  "page_name": "",
  "create_time": 123456,
  "has_draft": true
}
```

字段说明：

| 名称 | 备注 |
| - | - |
| `page_id`     | 页面ID |
| `page_name`   | 页面名称 |
| `create_time` | 创建时间 |
| `has_draft`   | 是否含有草稿 |

---

# PageVersion

## POST `/api/page_save`

保存一个版本。

### 输入字节流

以下列结构开头，后跟页面内容：

```C++
struct PAGE_REQ_HEADER
{
    UINT Magic;         // PrhMagic
    int iPageId;
    BOOL bTemp;         // TRUE = 草稿
    BOOL bCompressed;   // TRUE = gzip压缩
    DbPageType eType;
    UINT crc32;
    UINT cbContent;     // 不含本结构
    ApiResult r;
    UINT r2;
    // BYTE byContent[];
};
```

| 名称 | 备注 |
| - | - |
| `Magic`       | 设为`0xDEADBEEF` |
| `iPageId`     | 页面ID |
| `bTemp`       | 是否保存或请求草稿 |
| `bCompressed` | 随后内容是否使用gzip压缩 |
| `eType`       | 页面类型，当前必须设为`1` |
| `crc32`       | 后续内容的CRC32 |
| `cbContent`   | 内容长度，可能为`0` |
| `r`           | 错误码，输入时忽略此字段 |
| `r2`          | 附加错误码，输入时忽略此字段 |

注意：

+ `BOOL`为4字节整数，只可取`0`或`1`
+ 所有整数均为小端


## GET `/api/page_load`

加载页面内容。

### 参数（Query）

| 名称 | 备注 |
| - | - |
| `page_id` | 页面ID |

### 返回

返回数据与 POST `/api/page_save`的输入相同。


## GET `/api/page_version_list`

获取某页面的版本列表。

### 参数（Query）

| 名称 | 可选 | 备注 |
| - | :-: | - |
| `page_id` | | 页面ID |
| `count`    | 是 | 返回条数 |
| `page`     | 是 | 页码 |

### 返回

`data`为数组，每项定义如下：

```json
{
  "ver_id": 0,
  "user_id": 0,
  "create_at": 123456,
  "description": "",
}
```

| 名称 | 备注 |
| - | - |
| `ver_id`      | 版本ID |
| `user_id`     | 创建此版本的用户ID |
| `create_at`   | 版本创建时间 |
| `description` | 描述 |


## GET `/api/page_version_content`

加载页面某个版本的内容。

### 参数（Query）

| 名称 | 备注 |
| - | - |
| `ver_id`  | 版本ID |
| `page_id` | 页面ID |

### 返回

返回数据与 POST `/api/page_save`的输入相同。

---

# Auth

## GET `/api/login`

用户登录。

### 参数（Query）

| 名称 | 备注 |
| - | - |
| `user_name` | 用户名 |
| `password`  | 密码 |

### 返回

`data` 为对象，定义如下：

```json
{
  "role": 0,
}
```

字段说明：

| 名称 | 备注 |
| - | - |
| `role`     | 角色 |


## POST `/api/register`

用户注册。

### 参数（JSON）

| 名称 | 备注 |
| - | - |
| `name`     | 用户名 |
| `password` | 密码 |
| `key`      | 接口Key |
| `role`     | 角色 |

---

# Global

## GET `/api/search`

搜索页面组、项目、页面、任务四种对象

### 参数（Query）

| 名称 | 可选 | 备注 |
| - | :-: | - |
| `keyword`  | | 关键词 |
| `count`    | 是 | 返回条数 |
| `page`     | 是 | 页码 |

### 返回

`data` 为对象，定义如下：

```json
{
  "entity_id": 0,
  "type": 0,
  "name": "",
  "create_at": 0,
  "container_id": 0,
}
```

字段说明：

| 名称 | 备注 |
| - | - |
| `entity_id` | 实体ID |
| `type`      | `1` 页面组 `2` 页面 `3` 项目 `4` 任务 |
| `name`      | 标题 |
| `create_at` | 创建时间 |
| `container_id` | 父对象ID，页面组和项目的此字段为-1 |
